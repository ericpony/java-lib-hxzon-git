(function(){function a(c,b){if(c.isListen("onClick")){if(b){jq(c.$n()).removeClass(c.getZclass()+"-body-clk-over")}else{jq(c.$n()).addClass(c.getZclass()+"-body-clk-over")}}}zul.menu.Menu=zk.$extends(zul.LabelImageWidget,{$define:{content:function(c){if(!c||c.length==0){return}if(!this._contentHandler){if(zk.feature.pe){var b=this;zk.load("zkex.inp",null,function(){b._contentHandler=new zkex.inp.ContentHandler(b,c)});return}this._contentHandler=new zul.menu.ContentHandler(this,c)}else{this._contentHandler.setContent(c)}},image:function(){this.rerender()}},domContent_:function(){var c=zUtl.encodeXML(this.getLabel()),b=['<span id="',this.uuid,'-img" class="',this.getZclass(),'-img"'];b.push(this._image?' style="background-image:url('+this._image+')"':"","></span>",c?" "+c:"");return b.join("")},isTopmost:function(){return this._topmost},beforeParentChanged_:function(b){this._topmost=b&&!(b.$instanceof(zul.menu.Menupopup));this.$supers("beforeParentChanged_",arguments)},getZclass:function(){return this._zclass==null?"z-menu":this._zclass},domStyle_:function(c){var b=this.$supers("domStyle_",arguments);return this.isTopmost()?b+"padding-left:4px;padding-right:4px;":b},onChildAdded_:function(b){this.$supers("onChildAdded_",arguments);if(b.$instanceof(zul.menu.Menupopup)){this.menupopup=b;if(this._contentHandler){this._contentHandler.destroy()}}},onChildRemoved_:function(b){this.$supers("onChildRemoved_",arguments);if(b==this.menupopup){this.menupopup=null;if(this._contentHandler){this._contentHandler.setContent(this._content)}}},getMenubar:function(){for(var b=this.parent;b;b=b.parent){if(b.$instanceof(zul.menu.Menubar)){return b}}return null},onShow:function(){if(this._contentHandler){this._contentHandler.onShow()}},onFloatUp:function(b){if(this._contentHandler){this._contentHandler.onFloatUp(b)}},onHide:function(){if(this._contentHandler){this._contentHandler.onHide()}},bind_:function(){this.$supers(zul.menu.Menu,"bind_",arguments);var c=this.$n("a"),b=this._contentType;if(!this.isTopmost()){var d=this.$n();this.domListen_(c,"onFocus","doFocus_").domListen_(c,"onBlur","doBlur_").domListen_(d,"onMouseOver").domListen_(d,"onMouseOut")}else{this.domListen_(c,"onMouseOver").domListen_(c,"onMouseOut");if(this.isListen("onClick")){jq(this.$n()).addClass(this.getZclass()+"-body-clk")}}if(this._contentHandler){this._contentHandler.bind()}},unbind_:function(){if(!this.isTopmost()){var b=this.$n("a"),c=this.$n();this.domUnlisten_(b,"onFocus","doFocus_").domUnlisten_(b,"onBlur","doBlur_").domUnlisten_(c,"onMouseOver").domUnlisten_(c,"onMouseOut")}else{var b=this.$n("a");this.domUnlisten_(b,"onMouseOver").domUnlisten_(b,"onMouseOut")}if(this._contentHandler){this._contentHandler.unbind()}this.$supers(zul.menu.Menu,"unbind_",arguments)},_getArrowWidth:function(){return 15},doClick_:function(j){var d=this.$n();if(this.menupopup){jq(this.$n("a")).addClass(this.getZclass()+"-body-seld");this.menupopup._shallClose=false;if(this.isTopmost()){this.getMenubar()._lastTarget=this}if(this.isListen("onClick")){var f=this._getArrowWidth(),e=this.isTopmost()?jq(d).find("TABLE"):jq(d),h=zk(e).offsetWidth(),b=h-f,i=zk(e).revisedOffset(),c=j.domEvent.clientX-i[0];if(c>b){this._togglePopup();j.stop()}else{jq(this.$n("a")).removeClass(this.getZclass()+"-body-seld");this.fireX(j)}}else{this._togglePopup()}}else{var g=this._contentHandler;if(g&&!g.isOpen()){g.onShow()}}},doMouseOver_:function(){if(!this.isTopmost()){var b=this._contentHandler;if(b&&!b.isOpen()){b.onShow()}}this.$supers("doMouseOver_",arguments)},_togglePopup:function(){if(!this.menupopup.isOpen()){if(this.isTopmost()){a(this)}this.menupopup.open()}else{if(this.isTopmost()){this.menupopup.close({sendOnOpen:true})}else{zk(this.menupopup.$n("a")).focus()}}},_doMouseOver:function(b){var d=this.getMenubar();if(d){d._bOver=true;d._noFloatUp=false}if(this.$class._isActive(this)){return}var c=this.isTopmost();if(c){a(this)}if(c&&zk.ie&&!jq.isAncestor(this.$n("a"),b.domTarget)){return}if(this.menupopup){this.menupopup._shallClose=false}if(!c){zWatch.fire("onFloatUp",this);if(this.menupopup&&!this.menupopup.isOpen()){this.menupopup.open()}}else{if(this.menupopup&&d._autodrop){d._lastTarget=this;zWatch.fire("onFloatUp",this);if(!this.menupopup.isOpen()){this.menupopup.open()}}else{var e=d._lastTarget;if(e&&e!=this&&d._lastTarget.menupopup&&d._lastTarget.menupopup.isVisible()){d._lastTarget.menupopup.close({sendOnOpen:true});this.$class._rmActive(d._lastTarget);d._lastTarget=this;if(this.menupopup){this.menupopup.open()}}}}this.$class._addActive(this)},_doMouseOut:function(b){var d=this.getMenubar();if(d){d._bOver=false}this._updateHoverImage();if(!zk.ie&&jq.isAncestor(this.$n("a"),b.domEvent.relatedTarget||b.domEvent.toElement)){return}var c=this.isTopmost(),e=this.menupopup;if(c){this.$class._rmOver(this);if(e&&d._autodrop){if(e.isOpen()){e._shallClose=true}d._closeOnOut()}}else{if(!e||!e.isOpen()){this.$class._rmActive(this)}else{if(e&&d&&d._autodrop){d._closeOnOut()}}}},getImageNode:function(){if(!this._eimg&&(this._image||this._hoverImage)){var b=this.$n();if(b){this._eimg=this.$n("b")}}return this._eimg}},{_isActive:function(e){var d=e.isTopmost(),f=d?e.$n("a"):e.$n(),c=e.menupopup,b=e.getZclass();b+=d?c&&c.isOpen()?"-body-seld":"-body-over":"-over";return jq(f).hasClass(b)},_addActive:function(e){var d=e.isTopmost(),f=d?e.$n("a"):e.$n(),c=e.menupopup,b=e.getZclass();b+=d?c&&c.isOpen()?"-body-seld":"-body-over":"-over";jq(f).addClass(b);if(!d&&e.parent.parent.$instanceof(zul.menu.Menu)){this._addActive(e.parent.parent)}},_rmActive:function(f){var d=f.isTopmost(),g=d?f.$n("a"):f.$n(),e=f.getZclass(),b=e;b+=d?f.menupopup.isOpen()?"-body-seld":"-body-over":"-over";var c=jq(g);c.removeClass(b);if(!(c.hasClass(e+"-body-seld")||c.hasClass(e+"-body-over"))){a(f,true)}},_rmOver:function(f){var d=f.isTopmost(),g=d?f.$n("a"):f.$n(),e=f.getZclass(),b=e+(d?"-body-over":"-over");var c=jq(g);c.removeClass(b);if(!c.hasClass(e+"-body-seld")){a(f,true)}}});zul.menu.ContentHandler=zk.$extends(zk.Object,{$init:function(c,b){this._wgt=c;this._content=b},setContent:function(b){if(this._content!=b||!this._pp){this._content=b;this._wgt.rerender()}},redraw:function(b){var d=this._wgt,c=d.getZclass();b.push('<div id="',d.uuid,'-cnt-pp" class="',c,'-cnt-pp" style="display:none"><div class="',c,'-cnt-body">',this._content,"</div></div>")},bind:function(){var b=this._wgt;if(!b.menupopup){b.domListen_(b.$n(),"onClick","onShow");zWatch.listen({onFloatUp:b,onHide:b})}this._pp=jq("#"+b.uuid+"-cnt-pp")[0]},unbind:function(){var b=this._wgt;if(!b.menupopup){if(this._shadow){this._shadow.destroy();this._shadow=null}b.domUnlisten_(b.$n(),"onClick","onShow");zWatch.unlisten({onFloatUp:b,onHide:b})}this._pp=null},isOpen:function(){var b=this._pp;return(b&&zk(b).isVisible())},onShow:function(){var c=this._wgt,b=this._pp;if(!b){return}b.style.width=b.style.height="auto";b.style.position="absolute";b.style.overflow="auto";b.style.display="block";b.style.zIndex="88000";jq(b).zk.makeVParent();zWatch.fireDown("onVParent",this);zk(b).position(c.$n(),this.getPosition());this.syncShadow()},onHide:function(){var b=this._pp;if(!b||!zk(b).isVisible()){return}b.style.display="none";jq(b).zk.undoVParent();zWatch.fireDown("onVParent",this);this.hideShadow()},onFloatUp:function(b){if(!zUtl.isAncestor(this._wgt,b.origin)){this.onHide()}},syncShadow:function(){if(!this._shadow){this._shadow=new zk.eff.Shadow(this._wgt.$n("cnt-pp"),{stackup:(zk.useStackup===undefined?zk.ie6_:zk.useStackup)})}this._shadow.sync()},hideShadow:function(){this._shadow.hide()},destroy:function(){this._wgt.rerender()},getPosition:function(){var c=this._wgt;if(c.isTopmost()){var b=c.getMenubar();if(b){return"vertical"==b.getOrient()?"end_before":"after_start"}}return"end_before"},deferRedrawHTML_:function(c){var b=this.isTopmost()?"td":"li";c.push("<",b,this.domAttrs_({domClass:1}),' class="z-renderdefer"></',b,">")}})})();