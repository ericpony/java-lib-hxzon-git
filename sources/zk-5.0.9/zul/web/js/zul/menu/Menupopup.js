(function(){function b(g){var f=g.parent;return f.$instanceof(zul.menu.Menu)?f:null}function d(f){return f.isVisible()&&(f.$instanceof(zul.menu.Menu)||(f.$instanceof(zul.menu.Menuitem)&&!f.isDisabled()))}function a(g,h){if(h){while(h=h.previousSibling){if(d(h)){g._curIndex--;return h}}}g._curIndex=-1;for(var f=g.firstChild;f;f=f.nextSibling){if(d(f)){h=f;g._curIndex++}}return h}function c(g,h){if(h){while(h=h.nextSibling){if(d(h)){g._curIndex++;return h}}}for(var f=g.firstChild;f;f=f.nextSibling){if(d(f)){g._curIndex=0;return f}}}function e(g){var i=g._curIndex;if(i>=0){for(var f=g.firstChild,h=0;f;f=f.nextSibling){if(d(f)&&h++==i){return f}}}}zul.menu.Menupopup=zk.$extends(zul.wgt.Popup,{_curIndex:-1,getZclass:function(){return this._zclass==null?"z-menu-popup":this._zclass},zsync:function(){this.$supers("zsync",arguments);if(!this._shadow){this._shadow=new zk.eff.Shadow(this.$n())}this._shadow.sync()},_hideShadow:function(){if(this._shadow){this._shadow.hide()}},close:function(){if(this.isOpen()){zul.menu._nOpen--}this.$supers("close",arguments);jq(this.$n()).hide();this._hideShadow();var g;if((g=b(this))&&g.isTopmost()){jq(g.$n("a")).removeClass(g.getZclass()+"-body-seld")}var f=e(this);if(f){f.$class._rmActive(f)}this._curIndex=-1;this.$class._rmActive(this)},open:function(h,j,f,g){if(!this.isOpen()){zul.menu._nOpen++}var i;if(i=b(this)){if(!j){h=i.$n("a");if(!f){if(i.isTopmost()){f=i.parent.getOrient()=="vertical"?"end_before":"after_start"}else{f="end_before"}}}}this.$super("open",h,j,f,g||{sendOnOpen:true,disableMask:true});if(i){var k;if(k=this.$n()){k.style.top=jq.px0(zk.parseInt(k.style.top)+zk.parseInt(jq(this.getMenubar()).css("paddingBottom")))}}},shallStackup_:function(){return false},setTopmost:function(){this.$supers("setTopmost",arguments);this.zsync()},onFloatUp:function(f){if(!this.isVisible()){return}var i=f.origin;if(this.parent.menupopup==this&&!this.parent.isTopmost()&&!this.parent.$class._isActive(this.parent)){this.close({sendOnOpen:true});return}for(var h,g=i;g;g=g.parent){if(g==this||(g.menupopup==this&&!this._shallClose)){if(!h){this.setTopmost()}return}h=h||g.isFloating_()}if(i&&i.$instanceof(zul.menu.Menu)){for(var h,g=this;g=g.parent;){if(g==i){if(this._shallClose){break}if(!h){this.setTopmost()}return}h=h||g.isFloating_()}}this.close({sendOnOpen:true})},onShow:function(){if(zk.ie7_){var f=this.$n();if(!f.style.width){var g=this.$n("cave");if(g.childNodes.length){f.style.width=g.offsetWidth+zk(f).padBorderWidth()+"px"}}}this.zsync();var h=this.$n("a");if(h){if(zk(h).isRealVisible()){h.focus();zk.currentFocus=this}}},onHide:function(){if(this.isOpen()){this.close()}this._hideShadow()},bind_:function(){this.$supers(zul.menu.Menupopup,"bind_",arguments);zWatch.listen({onHide:this,onResponse:this});if(!zk.css3){jq.onzsync(this)}},unbind_:function(){if(this.isOpen()){this.close()}if(this._shadow){this._shadow.destroy()}if(!zk.css3){jq.unzsync(this)}this._shadow=null;zWatch.unlisten({onHide:this,onResponse:this});this.$supers(zul.menu.Menupopup,"unbind_",arguments)},onResponse:function(){if(!this.isOpen()){return}if(zk.ie7_){var f=this.$n();f.style.width="";var g=this.$n("cave");if(g.childNodes.length){f.style.width=g.offsetWidth+zk(f).padBorderWidth()+"px"}}this.zsync();this.$supers("onResponse",arguments)},doKeyDown_:function(h){var g=e(this),k,j=h.keyCode;switch(j){case 38:case 40:if(g){g.$class._rmActive(g)}g=j==38?a(this,g):c(this,g);if(g){g.$class._addActive(g)}break;case 37:this.close();if(((k=b(this)))&&!k.isTopmost()){var f=k.parent;if(f){var i=f.$n("a");if(i){i.focus()}}}break;case 39:if(g&&g.$instanceof(zul.menu.Menu)&&g.menupopup){g.menupopup.open()}break;case 13:if(g&&g.$instanceof(zul.menu.Menuitem)){g.doClick_(new zk.Event(g,"onClick",{}));zWatch.fire("onFloatUp",g);this.close({sendOnOpen:true})}break}if(j!=9){h.stop()}this.$supers("doKeyDown_",arguments)},getMenubar:zul.menu.Menu.prototype.getMenubar,doMouseOver_:function(f){var g=this.getMenubar();if(g){g._bOver=true}this._shallClose=false;this.$supers("doMouseOver_",arguments)},doMouseOut_:function(f){var g=this.getMenubar();if(g){g._bOver=false}this.$supers("doMouseOut_",arguments)}},{_rmActive:function(f){if(f.parent.$instanceof(zul.menu.Menu)){f.parent.$class._rmActive(f.parent)}}});zul.menu._nOpen=0})();