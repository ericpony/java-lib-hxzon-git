zul.sel.Select=zk.$extends(zul.Widget,{_selectedIndex:-1,_rows:0,$init:function(){this.$supers("$init",arguments);this._selItems=[]},$define:{multiple:function(a){var b=this.$n();if(b){b.multiple=a?"multiple":""}},disabled:function(a){var b=this.$n();if(b){b.disabled=a?"disabled":""}},selectedIndex:function(a){var d=0,c=0,b,e=this.$n();this.clearSelection();for(b=this.firstChild;b&&d<a;b=b.nextSibling,d++){if(b.$instanceof(zul.sel.Option)){if(!b.isVisible()){c++}}else{d--}}a-=c;if(e){e.selectedIndex=a}if(a>-1&&b&&b.$instanceof(zul.sel.Option)){b.setSelected(true);this._selItems.push(b)}},tabindex:function(a){var b=this.$n();if(b){b.tabindex=a||""}},name:function(a){var b=this.$n();if(b){b.name=a}},rows:function(a){var b=this.$n();if(b){b.size=a}},maxlength:function(a){if(this.desktop){this.rerender()}}},toggleItemSelection:function(a){if(a.isSelected()){this._removeItemFromSelection(a)}else{this._addItemToSelection(a)}},selectItem:function(a){if(!a){this.setSelectedIndex(-1)}else{if(this._multiple||!a.isSelected()){this.setSelectedIndex(a.getChildIndex())}}},_addItemToSelection:function(b){if(!b.isSelected()){if(!this._multiple){this.selectItem(b)}else{var a=b.getChildIndex();if(a<this._selectedIndex||this._selectedIndex<0){this._selectedIndex=a}b._setSelectedDirectly(true);this._selItems.push(b)}}},_removeItemFromSelection:function(a){if(a.isSelected()){if(!this._multiple){this.clearSelection()}else{a._setSelectedDirectly(false);this._selItems.$remove(a)}}},clearSelection:function(){if(this._selItems.length){var a;for(;(a=this._selItems.pop());){a._setSelectedDirectly(false)}this._selectedIndex=-1}},domAttrs_:function(){var a;return this.$supers("domAttrs_",arguments)+(this.isDisabled()?' disabled="disabled"':"")+(this.isMultiple()?' multiple="multiple"':"")+((a=this.getSelectedIndex())>-1?' selectedIndex="'+a+'"':"")+((a=this.getTabindex())?' tabindex="'+a+'"':"")+((a=this.getRows())>0?' size="'+a+'"':"")+((a=this.getName())?' name="'+a+'"':"")},bind_:function(){this.$supers(zul.sel.Select,"bind_",arguments);var b=this.$n();this.domListen_(b,"onChange").domListen_(b,"onFocus","doFocus_").domListen_(b,"onBlur","doBlur_");if(!zk.gecko){var a=[this,this._fixSelIndex];zWatch.listen({onRestore:a,onVParent:a})}this._fixSelIndex()},unbind_:function(){var b=this.$n();this.domUnlisten_(b,"onChange").domUnlisten_(b,"onFocus","doFocus_").domUnlisten_(b,"onBlur","doBlur_").$supers(zul.sel.Select,"unbind_",arguments);var a=[this,this._fixSelIndex];zWatch.unlisten({onRestore:a,onVParent:a})},_fixSelIndex:function(){if(this._selectedIndex<0){this.$n().selectedIndex=-1}},_doChange:function(l){var h=[],e,d=this.$n();if(this._multiple){var a=d.options,g;for(var f=0,i=a.length;f<i;++f){var b=a[f],c=zk.Widget.$(b.id),k=b.selected;if(c&&c._selected!=k){c.setSelected(k);g=true}if(k){h.push(b.id);if(!e){e=b.id}}}if(!g){return}}else{var k=d.selectedIndex;if(zk.opera){d.selectedIndex=k}if(this._selectedIndex==k){return}this.setSelectedIndex(k);h.push(e=d.options[k].id)}this.fire("onSelect",{items:h,reference:e})},doBlur_:function(a){this._doChange(a);return this.$supers("doBlur_",arguments)},beforeCtrlKeys_:function(a){this._doChange(a)},onChildAdded_:function(){this.rerender()},onChildRemoved_:function(){if(!this.childReplacing_){this.rerender()}}});