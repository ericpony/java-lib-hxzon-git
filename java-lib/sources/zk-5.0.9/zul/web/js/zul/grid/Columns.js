zul.grid.Columns=zk.$extends(zul.mesh.HeadWidget,{_menupopup:"none",_columnshide:true,_columnsgroup:true,$define:{columnshide:_zkf=function(){if(this.desktop){this._initColMenu()}},columnsgroup:_zkf,menupopup:function(){if(this._menupopup!="auto"){this._mpop=null}this.rerender()}},getGrid:function(){return this.parent},rerender:function(){if(this.desktop){if(this.parent){this.parent.rerender()}else{this.$supers("rerender",arguments)}}return this},setPopup:function(a){if(zk.Widget.isInstance(a)){this._menupopup=a;this._mpop=null}return this},getZclass:function(){return this._zclass==null?"z-columns":this._zclass},bind_:function(b,d,c){this.$supers(zul.grid.Columns,"bind_",arguments);zWatch.listen({onResponse:this});var a=this;if(this._menupopup=="auto"){c.push(function(){a._initColMenu()})}},unbind_:function(){zWatch.unlisten({onResponse:this});if(this._mpop){this._mpop.parent.removeChild(this._mpop);this._shallColMenu=this._mpop=null}this.$supers(zul.grid.Columns,"unbind_",arguments)},onResponse:function(){if(this._shallColMenu){this.syncColMenu()}},_syncColMenu:function(){this._shallColMenu=true},onChildAdded_:function(a){this.$supers("onChildAdded_",arguments);this._syncColMenu()},onChildRemoved_:function(a){this.$supers("onChildRemoved_",arguments);if(!this.childReplacing_){this._syncColMenu()}},_initColMenu:function(){if(this._mpop){this._mpop.parent.removeChild(this._mpop)}this._mpop=new zul.grid.ColumnMenupopup({columns:this})},syncColMenu:function(){this._shallColMenu=false;if(this._mpop){this._mpop.syncColMenu()}},_onColVisi:function(c){var f=c.currentTarget,b=f.parent;b.close({sendOnOpen:true});var e=0;for(var a=b.firstChild;a;a=a.nextSibling){if(a.$instanceof(zul.menu.Menuitem)&&a.isChecked()){e++}}if(e==0){f.setChecked(true)}var d=zk.Widget.$(f._col);if(d&&d.parent==this){d.setVisible(f.isChecked())}},_onGroup:function(a){this._mref.fire("onGroup")},_onAsc:function(a){this._mref.fire("onSort",true)},_onDesc:function(a){this._mref.fire("onSort",false)},_onMenuPopup:function(a){if(this._mref){var b=this._mref.getZclass(),c=this._mref.$n();jq(c).removeClass(b+"-visi").removeClass(b+"-over")}this._mref=a.data.reference}});zul.grid.ColumnMenupopup=zk.$extends(zul.menu.Menupopup,{$define:{columns:null},$init:function(){this.$supers("$init",arguments);this.afterInit(this._init)},getAscitem:function(){return this._asc},getDescitem:function(){return this._desc},getGroupitem:function(){return this._group},_init:function(){var a=this._columns,e=a.getZclass();this.listen({onOpen:[a,a._onMenuPopup]});if(zk.feature.pe&&a.isColumnsgroup()){if(!zk.isLoaded("zkex.grid")){zk.load("zkex.grid")}var c=new zul.menu.Menuitem({label:msgzul.GRID_GROUP});c.setSclass(e+"-menu-grouping");c.listen({onClick:[a,a._onGroup]});this.appendChild(c);this._group=c}var b=new zul.menu.Menuitem({label:msgzul.GRID_ASC});b.setSclass(e+"-menu-asc");b.listen({onClick:[a,a._onAsc]});this._asc=b;this.appendChild(b);var d=new zul.menu.Menuitem({label:msgzul.GRID_DESC});d.setSclass(e+"-menu-dsc");d.listen({onClick:[a,a._onDesc]});this._desc=d;this.appendChild(d);this.syncColMenu();a.getPage().appendChild(this)},syncColMenu:function(){var a=this._columns;for(var f=this.lastChild,e;f!=this._desc;){e=f.previousSibling;this.removeChild(f);f=e}if(a&&a.isColumnshide()){var b=new zul.menu.Menuseparator();this.appendChild(b);for(var d,f=a.firstChild;f;f=f.nextSibling){d=new zul.menu.Menuitem({label:f.getLabel(),autocheck:true,checkmark:true,checked:f.isVisible()});d._col=f.uuid;d.listen({onClick:[a,a._onColVisi]});this.appendChild(d)}}}});