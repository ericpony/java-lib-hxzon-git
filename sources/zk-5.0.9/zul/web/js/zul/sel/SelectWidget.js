(function(){function c(j,i){return zAu.processing()||j._shallIgnore(i)||(!j._focusItem&&!j.getSelectedItem())}function g(i){switch(i.data.keyCode){case 33:case 34:case 38:case 40:case 37:case 39:case 32:case 36:case 35:i.stop();return false}return true}function e(j){if(--j._nUpdHeaderCM<=0&&j.desktop&&j._headercm&&j._multiple){var k=zk.Widget.$(j._headercm).getZclass()+"-img-seld",i=jq(j._headercm);i[j._isAllSelected()?"addClass":"removeClass"](k)}}function b(i){return i.target.$button||(zk.isLoaded("zul.wgt")&&i.target.$instanceof(zul.wgt.Button,zul.wgt.Toolbarbutton))}function f(i){return i.target.$inputWidget||(zk.isLoaded("zul.inp")&&i.target.$instanceof(zul.inp.InputWidget))}function a(i){return(jq.nodeName(i.domTarget,"input","textarea","button","select","option","a")&&!i.target.$instanceof(zul.sel.SelectWidget))||b(i)||f(i)}function h(i){return i&&(i=i.uuid)?zk.Widget.$(i):null}var d=zul.sel.SelectWidget=zk.$extends(zul.mesh.MeshWidget,{_rows:0,rightSelect:true,$init:function(){this.$supers("$init",arguments);this._selItems=[]},$define:{rows:function(i){var j=this.$n();if(j){j._lastsz=null;this.onSize()}},checkmark:function(i){if(this.desktop){this.rerender()}},multiple:function(i){if(!this._multiple&&this._selItems.length){var k=this.getSelectedItem();for(var j;(j=this._selItems.pop());){if(j!=k){if(!this._checkmark){j._setSelectedDirectly(false)}else{j._selected=false}}}this._selItems.push(k)}if(this._checkmark&&this.desktop){this.rerender()}},selectedIndex:[function(i){return i<-1||(!i&&i!==0)?-1:i},function(){var k=this._selectedIndex;this.clearSelection();this._selectedIndex=k;if(k>-1){var i;for(var j=this.getBodyWidgetIterator();k-->=0;){i=j.next()}if(i){this._selectOne(i,true);zk(i).scrollIntoView(this.ebody);if(zk.ff>=4&&this.ebody){this._currentTop=this.ebody.scrollTop;this._currentLeft=this.ebody.scrollLeft}}}}],name:function(){if(this.destkop){this.updateFormData()}}},setChgSel:function(q){var i={};for(var n=0;;){var m=q.indexOf(",",n),p=(m>=0?q.substring(n,m):q.substring(n)).trim();if(p){i[p]=true}if(m<0){break}n=m+1}for(var o=this.getBodyWidgetIterator(),l;(l=o.next());){this._changeSelect(l,i[l.uuid]==true)}},updateFormData:function(){if(this._name){if(!this.efield){this.efield=jq(this.$n()).append('<div style="display:none;"></div>').find("> div:last-child")[0]}jq(this.efield).children().remove();var n=[],m='<input type="hidden" name="'+this._name+'" value="';for(var l=0,k=this._selItems.length;l<k;l++){n.push(m,this._selItems[l].getValue(),'"/>')}jq(this.efield).append(n.join(""))}else{if(this.efield){jq(this.efield).remove();this.efield=null}}},setSelectedItem:function(i){if(!i){this.clearSelection()}else{if(i=zk.Widget.$(i)){this._selectOne(i,true);zk(i).scrollIntoView(this.ebody);if(zk.ff>=4&&this.ebody){this._currentTop=this.ebody.scrollTop;this._currentLeft=this.ebody.scrollLeft}}}},getSelectedItem:function(){return this._selItems[0]},getSelectedItems:function(){return this._selItems.$clone()},setHeight:function(i){if(!this._nvflex&&this._height!=i){this._height=i;var j=this.$n();if(j){j.style.height=i||"";this.onSize()}}},setVflex:function(i){this.$supers("setVflex",arguments);if(this.desktop){this.onSize()}},setHflex:function(i){this.$supers("setHflex",arguments);if(this.desktop){this.onSize()}},_getEbodyWd:function(){var i=this.$n("a");if(zk.safari){i.style.display="none"}var j=zk.opera&&this.ebody.offsetHeight==0?this.ebody.offsetWidth:this.ebody.clientWidth;if(zk.safari){i.style.display=""}return j},_beforeCalcSize:function(){if(zk.ie8){var i=this.$n("a");this._oldCSS=i.style.display;i.style.display="none"}if(zk.ie){this._syncFocus(this._focusItem)}this._calcHgh()},_afterCalcSize:function(){if(zk.ie8){this.$n("a").style.display=this._oldCSS;delete this._oldCSS}this.$supers("_afterCalcSize",arguments)},_calcHgh:function(){var t=this.ebodyrows,E=this.$n(),s=E.style.height,C=s&&s!="auto"&&s.indexOf("%")<0;if(C){s=zk.parseInt(s);if(s){s-=this._headHgh(0);if(s<20){s=20}var z=0;l_out:for(var J,H=0,v=t.length;H<v;++z,++H){var A;for(;;++H){if(H>=v){break l_out}A=t[H];if(zk(A).isVisible()){break}}var K=zk(A);J=K.offsetTop()+K.offsetHeight();if(J>=s){if(J>s+2){++z}break}}z=Math.ceil(z&&J?(s*z)/J:s/this._headHgh(20));this._visibleRows(z);s-=(this.efoot?this.efoot.offsetHeight:0);s-=(this.efrozen?this.efrozen.offsetHeight:0);this.ebody.style.height=(s<0?0:s)+"px";if(zk.ie&&this.ebody.offsetHeight){}return}}var m=0,y=this.getRows(),F,k,i;for(var H=0,v=t.length;H<v;++H){var A=t[H];if(zk(A).isVisible()){++m;if(!k){k=A}if(y===m){i=A;break}F=A}}s=0;var x=2;if(!y){if(this.isVflex()){s=this._vflexSize(E.style.height);if(zk.ie&&this._cachehgh!=s){s-=1;this._cachehgh=s}if(s<25){s=25}var B=k?zk(k).offsetHeight():null;if(!B){B=this._headHgh(20)}y=Math.round((s-x)/B)}this._visibleRows(y)}if(y){if(!s){if(!m){s=this._headHgh(20)*y}else{var l=this.$n("tpad"),I=(l?l.offsetHeight:0),q=I>0&&this._padsz&&this._padsz.tpad?this._padsz.tpad:I<0?0:I;if(y<=m){var D=zk(i);s=D.offsetTop()+D.offsetHeight()-q}else{var G=zk(F);s=G.offsetTop()+G.offsetHeight()-q;s=Math.ceil((y*s)/m)}}if(zk.ie){s+=x}}if(zk.opera){this.ebody.style.height="";if(this.ebody.offsetHeight){}}this.ebody.style.height=s+"px";if(zk.safari){zk(this.ebody).redoCSS()}if(zk.ie&&this.ebody.offsetHeight){}var J=E.style.height;if(!J||J=="auto"){if(zk.ie&&!zk.ie8&&this.ebodytbl){var p=this.ebody.offsetWidth,o=this.ebody.clientWidth,u=p-o;if(o&&u>11){if(p==this.ebodytbl.offsetWidth){this.ebodytbl.style.width=jq.px0(zk(this.ebodytbl).revisedWidth(this.ebodytbl.offsetWidth-u))}}}}}else{s=E.style.height;if(zk.ie&&(!s||s=="auto")&&zk(this.ebody).hasVScroll()){if(!m){this.ebody.style.height=""}else{this.ebody.style.height=(this.ebody.offsetHeight*2-this.ebody.clientHeight)+"px"}}else{this.ebody.style.height=""}}},_visibleRows:function(i){if("number"==typeof i){this._visiRows=i}else{return this.getRows()||this._visiRows||0}},_headHgh:function(l){var j=this.ehead?this.ehead.offsetHeight:0;if(this.paging){var k=this.$n("pgit"),i=this.$n("pgib");if(k){j+=k.offsetHeight}if(i){j+=i.offsetHeight}}return j?j:l},indexOfItem:function(m){if(m.getMeshWidget()==this){for(var k=0,l=this.getBodyWidgetIterator(),j;(j=l.next());k++){if(j==m){return k}}}return -1},toggleItemSelection:function(i){if(i.isSelected()){this._removeItemFromSelection(i)}else{this._addItemToSelection(i)}this.updateFormData()},selectItem:function(i){if(!i){this.setSelectedIndex(-1)}else{if(this._multiple||!i.isSelected()){this.setSelectedIndex(this.indexOfItem(i))}}},_addItemToSelection:function(j){if(!j.isSelected()){if(!this._multiple){this._selectedIndex=this.indexOfItem(j)}else{var i=this.indexOfItem(j);if(i<this._selectedIndex||this._selectedIndex<0){this._selectedIndex=i}j._setSelectedDirectly(true)}this._selItems.push(j)}},_removeItemFromSelection:function(i){if(i.isSelected()){if(!this._multiple){this.clearSelection()}else{i._setSelectedDirectly(false);this._selItems.$remove(i)}}},clearSelection:function(){if(this._selItems.length){for(var i;(i=this._selItems.pop());){i._setSelectedDirectly(false)}this._selectedIndex=-1;this._updHeaderCM()}},focus_:function(l){var j;if(j=this.$n("a")){if(this._focusItem){for(var k=this.getBodyWidgetIterator(),i;(i=k.next());){if(this._isFocus(i)){i.focus_(l);break}}}else{if(this._currentTop){j.style.top=this._currentTop+"px"}if(this._currentLeft){j.style.left=this._currentLeft+"px"}}this.focusA_(j,l);return true}return false},focusA_:function(i,j){zk(i).focus(j)},bind_:function(){this.$supers(d,"bind_",arguments);var i=this.$n("a");if(i){this.domListen_(i,"onFocus","doFocus_").domListen_(i,"onKeyDown").domListen_(i,"onBlur","doBlur_")}this.updateFormData();this._updHeaderCM()},unbind_:function(){var i=this.$n("a");if(i){this.domUnlisten_(i,"onFocus","doFocus_").domUnlisten_(i,"onKeyDown").domUnlisten_(i,"onBlur","doBlur_")}this.$supers(d,"unbind_",arguments)},clearCache:function(){this.$supers("clearCache",arguments);this.efield=null},doFocus_:function(i){var j=this._focusItem||this._lastSelectedItem;if(j){j._doFocusIn()}this.$supers("doFocus_",arguments)},doBlur_:function(i){if(this._focusItem){this._lastSelectedItem=this._focusItem;this._focusItem._doFocusOut()}this._focusItem=null;this.$supers("doBlur_",arguments)},shallIgnoreSelect_:function(i){return i.name=="onRightClick"?this.rightSelect?-1:true:false},_shallIgnore:function(k,m){if(!k.domTarget||!k.target.canActivate()){return true}if(m){try{var l=k.domTarget;if(l){for(;;){if(l.id==this.uuid){break}if(!(l=l.parentNode)){return true}}}}catch(n){}if(typeof(m=this.nonselectableTags)=="string"){if(!m){return}if(m=="*"){return true}var i=jq.nodeName(k.domTarget),j=i=="input"&&k.domTarget.type.toLowerCase()=="button";if(m.indexOf(i)<0){return m.indexOf("button")>=0&&(b(k)||j)}return !j||m.indexOf("button")>=0}}return a(k)},_doItemSelect:function(p,k){var i,m=this._checkmark&&k.domTarget==p.$n("cm");if(zk.dragging||(!m&&(this._shallIgnore(k,true)||((i=this.shallIgnoreSelect_(k,p))&&!(i=i<0))))){return}var o=a(k);if(this._checkmark&&!k.data.shiftKey&&!(k.data.ctrlKey||k.data.metaKey)&&(!this._cdo||m)){this._syncFocus(p);if(this._multiple){var j=p.isSelected();if(!j||!i){this._toggleSelect(p,!j,k,o)}}else{this._select(p,k,o)}}else{if((zk.gecko||zk.safari)&&p.isListen("onDoubleClick")){var l=jq.now(),n=p._last;p._last=l;if(n&&l-n<900){return}}this._syncFocus(p);if(this._multiple){if(k.data.shiftKey){this._selectUpto(p,k,o)}else{if(k.data.ctrlKey||k.data.metaKey){this._toggleSelect(p,!p.isSelected(),k,o)}else{if(!i||!p.isSelected()){this._select(p,k,o)}}}}else{this._select(p,k,o)}if(!o){p.focus()}}},doKeyDown_:function(i){if(!this._shallIgnore(i)){switch(i.data.keyCode){case 33:case 34:case 38:case 40:case 37:case 39:case 32:case 36:case 35:if(!jq.nodeName(i.domTarget,"a")){this.focus()}if(i.domTarget==this.$n("a")){if(i.target==this){i.target=this._focusItem||this.getSelectedItem()||this}this._doKeyDown(i)}i.stop();return false}}if(!zk.gecko3||!jq.nodeName(i.domTarget,"input","textarea")){zk(this.$n()).disableSelection()}if(i.target==this){i.target=this._focusItem||this.getSelectedItem()||this}this.$supers("doKeyDown_",arguments)},doKeyUp_:function(i){zk(this.$n()).enableSelection();i.stop({propagation:true});this.$supers("doKeyUp_",arguments)},_doKeyDown:function(p){if(c(this,p)){return true}var s=this._focusItem||this.getSelectedItem(),n=p.data,k=n.shiftKey,j=(n.ctrlKey||n.metaKey);if(k&&!this._multiple){k=false}var o=false,l,q;if(zk.safari&&typeof n.keyCode=="string"){n.keyCode=zk.parseInt(n.keyCode)}switch(n.keyCode){case 33:case 34:l=this._visibleRows();if(l==0){l=20}if(n.keyCode==33){l=-l}break;case 38:case 40:l=n.keyCode==40?1:-1;break;case 32:if(this._multiple){this._toggleSelect(s,!s.isSelected(),p)}else{this._select(s,p)}break;case 36:case 35:l=n.keyCode==35?1:-1;o=true;break;case 37:this._doLeft(s);break;case 39:this._doRight(s);break}if(l){if(k){this._toggleSelect(s,true,p)}var m=s.$n();for(;m&&(m=l>0?m.nextSibling:m.previousSibling);){var i=zk.Widget.$(m);if(i.$instanceof(zul.sel.Treerow)){i=i.parent}if(!i.isDisabled()){if(k){this._toggleSelect(i,true,p)}if(zk(m).isVisible()){if(!k){q=i}if(!o){if(l>0){--l}else{++l}if(l==0){break}}}}}}if(q){if(j){this._focus(q)}else{this._select(q,p)}this._syncFocus(q);zk(q).scrollIntoView(this.ebody)}return g(p)},_doKeyUp:function(i){return c(this,i)||g(i)},_doLeft:zk.$void,_doRight:zk.$void,_syncFocus:function(k){var i=this.$n("a"),j,l;if(k&&(l=k.$n())){j=zk(l).revisedOffset();j=this._toStyleOffset(i,j[0]+this.ebody.scrollLeft,j[1])}else{j=[0,0]}i.style.top=j[1]+"px";i.style.left=j[0]+"px"},_toStyleOffset:function(m,j,n){var i=zk(m).revisedOffset(),k=zk.parseInt(m.style.left),l=zk.parseInt(m.style.top);return[j-i[0]+k,n-i[1]+l]},_select:function(k,i,j){if(this._selectOne(k,j)){this.fireOnSelect(k,i)}},_selectUpto:function(q,o,l){if(q.isSelected()){if(!l){this._focus(q)}return}var p=false,i=false,m=this._lastSelectedItem||this._focusItem;for(var j=this.getBodyWidgetIterator(),k=this.getSelectedItem(),n;(n=j.next());){if(n.isDisabled()){continue}if(p){this._changeSelect(n,true);if(n==q){break}}else{if(i){this._changeSelect(n,true);if(this._isFocus(n)||n==m){break}}else{if(!k){if(n!=q){continue}this._changeSelect(n,true);break}else{i=n==q;p=this._isFocus(n)||n==m;if(i||p){this._changeSelect(n,true);if(i&&p){break}}}}}}if(!l){this._focus(q)}this.fireOnSelect(q,o)},setSelectAll:_zkf=function(k,j){for(var l=this.getBodyWidgetIterator(),i;(i=l.next());){if(!i.isDisabled()){this._changeSelect(i,true)}}if(k&&j!==true){this.fireOnSelect(this.getSelectedItem(),j)}},selectAll:_zkf,_selectOne:function(l,j){var i=this.getSelectedItem();if(this._multiple){if(l&&!j){this._unsetFocusExcept(l)}var k=this._unsetSelectAllExcept(l);if(!k&&l&&i==l){if(!j){this._setFocus(l,true)}return false}}else{if(i){if(i==l){if(!j){this._setFocus(l,true)}return false}this._changeSelect(i,false);if(l){if(!j){this._setFocus(i,false)}}}if(l&&!j){this._unsetFocusExcept(l)}}if(l){this._changeSelect(l,true);if(!j){this._setFocus(l,true)}}return true},_toggleSelect:function(m,k,j,l){if(!this._multiple){var i=this.getSelectedItem();if(m!=i&&k){this._changeSelect(m,false)}}this._changeSelect(m,k);if(!l){this._focus(m)}this.fireOnSelect(m,j)},fireOnSelect:function(n,i){var o=[];for(var m=this.getSelectedItems(),l=m.length;l--;){if(m[l].isSelected()){o.push(m[l])}}var p,k=true;if(i){p=i.data;if(this._multiple){k=(p.ctrlKey||p.metaKey)||p.shiftKey||(this._checkmark&&(!this._cdo||(i.domTarget.id&&i.domTarget.id.endsWith("-cm"))))}}this.fire("onSelect",zk.copy({items:o,reference:n,clearFirst:!k},p))},_focus:function(i){if(this.canActivate({checkOnly:true})){this._unsetFocusExcept(i);this._setFocus(i,true)}},_changeSelect:function(k,i){var j=k.isSelected()!=i;if(j){k.setSelected(i);k._toggleEffect(true)}return j},_isFocus:function(i){return this._focusItem==i},_setFocus:function(j,k){var i=this._isFocus(j)!=k;if(i){if(k){if(!j.focus()){this.focus()}if(!this.paging&&zk.gecko){this.fireOnRender(5)}}}if(!k){j._doFocusOut()}return i},_unsetSelectAllExcept:function(m){var l=false;for(var k=this.getSelectedItems(),i=k.length;i--;){if(k[i]!=m&&this._changeSelect(k[i],false)){l=true}}return l},_unsetFocusExcept:function(i){if(this._focusItem&&this._focusItem!=i){this._setFocus(this._focusItem,false)}else{this._focusItem=null}},_updHeaderCM:function(){if(this._headercm&&this._multiple){var j=this,i;this._nUpdHeaderCM=(i=this._nUpdHeaderCM)>0?i+1:1;setTimeout(function(){e(j)},100)}},_syncBodyHeight:function(){if(this._rows==0){this.$supers("_syncBodyHeight",arguments)}},_isAllSelected:function(){for(var j=this.getBodyWidgetIterator({skipHidden:true}),i;(i=j.next());){if(!i.isDisabled()&&!i.isSelected()){return false}}return true},_ignoreHghExt:function(){return this._rows>0},onChildAdded_:function(i){this.$supers("onChildAdded_",arguments);if(this.desktop&&i.$instanceof(zul.sel.ItemWidget)&&i.isSelected()){this._syncFocus(i)}},onChildRemoved_:function(k){this.$supers("onChildRemoved_",arguments);var j=this._selItems,i;if(this.desktop&&k.$instanceof(zul.sel.ItemWidget)&&(i=j.length)){this._syncFocus(j[i-1])}},replaceWidget:function(i){this.$supers("replaceWidget",arguments);i._lastSelectedItem=h(this._lastSelectedItem);i._focusItem=h(this._focusItem)}})})();